/*! asmsimulator 27-10-2013 */
var app=angular.module("ASMSimulator",[]);app.service("assembler",["opcodes",function(a){return{go:function(b){for(var c=/^[\t ]*(?:([.A-Za-z]\w*)[:])?(?:[\t ]*([A-Za-z]{2,4})(?:[\t ]+(\[\w+\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*)(?:[\t ]*[,][\t ]*(\[\w+\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*))?)?)?/,d=/^[-+]?[0-9]+$/,e=/^[.A-Za-z]\w*$/,f=[],g={},h=b.split("\n"),i=function(a){if("0x"===a.slice(0,2))return parseInt(a.slice(2),16);if("0o"===a.slice(0,2))return parseInt(a.slice(2),8);if("b"===a.slice(a.length-1))return parseInt(a.slice(0,a.length-1),2);if("d"===a.slice(a.length-1))return parseInt(a.slice(0,a.length-1),10);if(d.exec(a))return parseInt(a,10);throw"Invalid number format"},j=function(a){return a=a.toUpperCase(),"A"===a?0:"B"===a?1:"C"===a?2:"D"===a?3:void 0},k=function(a,b,c){var d=j(a);if(void 0!==d)return{type:b,value:d};var e=l(a);if(void 0!==e)return{type:c,value:e};var f=i(a);if(isNaN(f))throw"Not a "+c+": "+f;if(0>f||f>255)throw c+" must have a value between 0-255";return{type:c,value:f}},l=function(a){return e.exec(a)?a.toUpperCase():void 0},m=function(a){switch(a.slice(0,1)){case"[":var b=a.slice(1,a.length-1);return k(b,"regaddress","address");case'"':for(var c=a.slice(1,a.length-1),d=[],e=0,f=c.length;f>e;e++)d.push(c.charCodeAt(e));return{type:"numbers",value:d};case"'":var g=a.slice(1,a.length-1);if(g.length>1)throw"Only one character is allowed. Use String instead";return{type:"number",value:g.charCodeAt(0)};default:return k(a,"register","number")}},n=(function(a){if(a=a.toUpperCase(),a in g)throw"Duplicate label: "+a;if("A"===a||"B"===a||"C"===a||"D"===a)throw"Label contains keyword: "+a;g[a]=f.length}),o=0,p=h.length;p>o;o++)try{var q=c.exec(h[o]);if(void 0!==q[1]||void 0!==q[2]){if(void 0!==q[1]&&n(q[1]),void 0!==q[2]){var r,s,t,u=q[2].toUpperCase();switch(u){case"DB":if(r=m(q[3]),"number"===r.type)f.push(r.value);else{if("numbers"!==r.type)throw"DB does not support this operand";for(var v=0,w=r.value.length;w>v;v++)f.push(r.value[v])}break;case"MOV":if(r=m(q[3]),s=m(q[4]),"register"===r.type&&"register"===s.type)t=a.MOV_REG_TO_REG;else if("register"===r.type&&"address"===s.type)t=a.MOV_ADDRESS_TO_REG;else if("register"===r.type&&"regaddress"===s.type)t=a.MOV_REGADDRESS_TO_REG;else if("address"===r.type&&"register"===s.type)t=a.MOV_REG_TO_ADDRESS;else if("regaddress"===r.type&&"register"===s.type)t=a.MOV_REG_TO_REGADDRESS;else if("register"===r.type&&"number"===s.type)t=a.MOV_NUMBER_TO_REG;else if("address"===r.type&&"number"===s.type)t=a.MOV_NUMBER_TO_ADDRESS;else{if("regaddress"!==r.type||"number"!==s.type)throw"MOV does not support this operands";t=a.MOV_NUMBER_TO_REGADDRESS}f.push(t,r.value,s.value);break;case"ADD":if(r=m(q[3]),s=m(q[4]),"register"===r.type&&"register"===s.type)t=a.ADD_REG_TO_REG;else if("register"===r.type&&"regaddress"===s.type)t=a.ADD_REGADDRESS_TO_REG;else if("register"===r.type&&"address"===s.type)t=a.ADD_ADDRESS_TO_REG;else{if("register"!==r.type||"number"!==s.type)throw"ADD does not support this operands";t=a.ADD_NUMBER_TO_REG}f.push(t,r.value,s.value);break;case"SUB":if(r=m(q[3]),s=m(q[4]),"register"===r.type&&"register"===s.type)t=a.SUB_REG_FROM_REG;else if("register"===r.type&&"regaddress"===s.type)t=a.SUB_REGADDRESS_FROM_REG;else if("register"===r.type&&"address"===s.type)t=a.SUB_ADDRESS_FROM_REG;else{if("register"!==r.type||"number"!==s.type)throw"SUB does not support this operands";t=a.SUB_NUMBER_FROM_REG}f.push(t,r.value,s.value);break;case"INC":if(r=m(q[3]),"register"!==r.type)throw"INC does not support this operand";t=a.INC_REG,f.push(t,r.value);break;case"DEC":if(r=m(q[3]),"register"!==r.type)throw"DEC does not support this operand";t=a.DEC_REG,f.push(t,r.value);break;case"CMP":if(r=m(q[3]),s=m(q[4]),"register"===r.type&&"register"===s.type)t=a.CMP_REG_WITH_REG;else if("register"===r.type&&"regaddress"===s.type)t=a.CMP_REGADDRESS_WITH_REG;else if("register"===r.type&&"address"===s.type)t=a.CMP_ADDRESS_WITH_REG;else{if("register"!==r.type||"number"!==s.type)throw"CMP does not support this operands";t=a.CMP_NUMBER_WITH_REG}f.push(t,r.value,s.value);break;case"JMP":if(r=m(q[3]),"register"===r.type)t=a.JMP_REGADDRESS;else{if("number"!==r.type)throw"JMP does not support this operands";t=a.JMP_ADDRESS}f.push(t,r.value);break;case"JC":case"JB":case"JNAE":if(r=m(q[3]),"register"===r.type)t=a.JC_REGADDRESS;else{if("number"!==r.type)throw u+" does not support this operand";t=a.JC_ADDRESS}f.push(t,r.value);break;case"JNC":case"JNB":case"JAE":if(r=m(q[3]),"register"===r.type)t=a.JNC_REGADDRESS;else{if("number"!==r.type)throw u+"does not support this operand";t=a.JNC_ADDRESS}f.push(t,r.value);break;case"JZ":case"JE":if(r=m(q[3]),"register"===r.type)t=a.JZ_REGADDRESS;else{if("number"!==r.type)throw u+" does not support this operand";t=a.JZ_ADDRESS}f.push(t,r.value);break;case"JNZ":case"JNE":if(r=m(q[3]),"register"===r.type)t=a.JNZ_REGADDRESS;else{if("number"!==r.type)throw u+" does not support this operand";t=a.JNZ_ADDRESS}f.push(t,r.value);break;case"JA":case"JNBE":if(r=m(q[3]),"register"===r.type)t=a.JA_REGADDRESS;else{if("number"!==r.type)throw u+" does not support this operand";t=a.JA_ADDRESS}f.push(t,r.value);break;case"JNA":case"JBE":if(r=m(q[3]),"register"===r.type)t=a.JNA_REGADDRESS;else{if("number"!==r.type)throw u+" does not support this operand";t=a.JNA_ADDRESS}f.push(t,r.value);break;case"PUSH":if(r=m(q[3]),"register"===r.type)t=a.PUSH_REG;else if("regaddress"===r.type)t=a.PUSH_REGADDRESS;else if("address"===r.type)t=a.PUSH_ADDRESS;else{if("number"!==r.type)throw"PUSH does not support this operand";t=a.PUSH_NUMBER}f.push(t,r.value);break;case"POP":if(r=m(q[3]),"register"!==r.type)throw"PUSH does not support this operand";t=a.POP_REG,f.push(t,r.value);break;case"CALL":if(r=m(q[3]),"register"===r.type)t=a.CALL_REGADDRESS;else{if("number"!==r.type)throw"CALL does not support this operand";t=a.CALL_ADDRESS}f.push(t,r.value);break;case"RET":t=a.RET,f.push(t);break;case"MUL":if(r=m(q[3]),"register"===r.type)t=a.MUL_REG;else if("regaddress"===r.type)t=a.MUL_REGADDRESS;else if("address"===r.type)t=a.MUL_ADDRESS;else{if("number"!==r.type)throw"MULL does not support this operand";t=a.MUL_NUMBER}f.push(t,r.value);break;case"DIV":if(r=m(q[3]),"register"===r.type&&(t=a.DIV_REG),"regaddress"===r.type&&(t=a.DIV_REGADDRESS),"address"===r.type&&(t=a.DIV_ADDRESS),"number"!==r.type)throw"DIV does not support this operand";t=a.DIV_NUMBER,f.push(t,r.value);break;case"AND":if(r=m(q[3]),s=m(q[4]),"register"===r.type&&"register"===s.type)t=a.AND_REG_WITH_REG;else if("register"===r.type&&"regaddress"===s.type)t=a.AND_REGADDRESS_WITH_REG;else if("register"===r.type&&"address"===s.type)t=a.AND_ADDRESS_WITH_REG;else{if("register"!==r.type||"number"!==s.type)throw"AND does not support this operands";t=a.AND_NUMBER_WITH_REG}f.push(t,r.value,s.value);break;case"OR":if(r=m(q[3]),s=m(q[4]),"register"===r.type&&"register"===s.type)t=a.OR_REG_WITH_REG;else if("register"===r.type&&"regaddress"===s.type)t=a.OR_REGADDRESS_WITH_REG;else if("register"===r.type&&"address"===s.type)t=a.OR_ADDRESS_WITH_REG;else{if("register"!==r.type||"number"!==s.type)throw"OR does not support this operands";t=a.OR_NUMBER_WITH_REG}f.push(t,r.value,s.value);break;case"XOR":if(r=m(q[3]),s=m(q[4]),"register"===r.type&&"register"===s.type)t=a.XOR_REG_WITH_REG;else if("register"===r.type&&"regaddress"===s.type)t=a.XOR_REGADDRESS_WITH_REG;else if("register"===r.type&&"address"===s.type)t=a.XOR_ADDRESS_WITH_REG;else{if("register"!==r.type||"number"!==s.type)throw"XOR does not support this operands";t=a.XOR_NUMBER_WITH_REG}f.push(t,r.value,s.value);break;case"NOT":if(r=m(q[3]),"register"!==r.type)throw"NOT does not support this operand";t=a.NOT_REG,f.push(t,r.value);break;case"SHL":case"SAL":if(r=m(q[3]),s=m(q[4]),"register"===r.type&&"register"===s.type)t=a.SHL_REG_WITH_REG;else if("register"===r.type&&"regaddress"===s.type)t=a.SHL_REGADDRESS_WITH_REG;else if("register"===r.type&&"address"===s.type)t=a.SHL_ADDRESS_WITH_REG;else{if("register"!==r.type||"number"!==s.type)throw u+" does not support this operands";t=a.SHL_NUMBER_WITH_REG}f.push(t,r.value,s.value);break;case"SHR":case"SAR":if(r=m(q[3]),s=m(q[4]),"register"===r.type&&"register"===s.type)t=a.SHR_REG_WITH_REG;else if("register"===r.type&&"regaddress"===s.type)t=a.SHR_REGADDRESS_WITH_REG;else if("register"===r.type&&"address"===s.type)t=a.SHR_ADDRESS_WITH_REG;else{if("register"!==r.type||"number"!==s.type)throw u+" does not support this operands";t=a.SHR_NUMBER_WITH_REG}f.push(t,r.value,s.value);break;default:throw"Invalid instruction: "+q[2]}}}else{var x=h[o].trim();if(""!==x&&";"!==x.slice(0,1))throw"Syntax error"}}catch(y){throw{error:y,line:o}}for(o=0,p=f.length;p>o;o++)if(!angular.isNumber(f[o])){if(!(f[o]in g))throw{error:"Undefined label: "+f[o]};f[o]=g[f[o]]}return f}}}]),app.service("cpu",["opcodes","memory",function(a,b){var c={step:function(){var c=this;if(c.fault===!0)throw"FAULT. Reset to continue.";try{var d=function(a){if(0>a||a>=c.gpr.length)throw"Invalid register: "+a;return a},e=function(a){return c.zero=!1,c.carry=!1,a>=256?(c.carry=!0,a%=256):0===a?c.zero=!0:0>a&&(c.carry=!0,a=255- -a%256),a},f=function(a){if(0>a||a>=b.data.length)throw"IP outside memory";c.ip=a},g=function(a){if(b.store(c.sp--,a),c.sp<0)throw"Stack overflow"},h=function(){var a=b.load(++c.sp);if(c.sp>231)throw"Stack underflow";return a},i=function(a){if(0===a)throw"Division by 0";return Math.floor(c.gpr[0]/a)};if(c.ip<0||c.ip>=b.data.length)throw"Instruction pointer is outside of memory";var j,k,l,m,n,o=b.load(c.ip);switch(o){case a.NONE:return!1;case a.MOV_REG_TO_REG:j=d(b.load(++c.ip)),k=d(b.load(++c.ip)),c.gpr[j]=c.gpr[k],c.ip++;break;case a.MOV_ADDRESS_TO_REG:j=d(b.load(++c.ip)),l=b.load(++c.ip),c.gpr[j]=b.load(l),c.ip++;break;case a.MOV_REGADDRESS_TO_REG:j=d(b.load(++c.ip)),k=d(b.load(++c.ip)),c.gpr[j]=b.load(c.gpr[k]),c.ip++;break;case a.MOV_REG_TO_ADDRESS:m=b.load(++c.ip),k=d(b.load(++c.ip)),b.store(m,c.gpr[k]),c.ip++;break;case a.MOV_REG_TO_REGADDRESS:j=d(b.load(++c.ip)),k=d(b.load(++c.ip)),b.store(c.gpr[j],c.gpr[k]),c.ip++;break;case a.MOV_NUMBER_TO_REG:j=d(b.load(++c.ip)),n=b.load(++c.ip),c.gpr[j]=n,c.ip++;break;case a.MOV_NUMBER_TO_ADDRESS:m=b.load(++c.ip),n=b.load(++c.ip),b.store(m,n),c.ip++;break;case a.MOV_NUMBER_TO_REGADDRESS:j=d(b.load(++c.ip)),n=b.load(++c.ip),b.store(c.gpr[j],n),c.ip++;break;case a.ADD_REG_TO_REG:j=d(b.load(++c.ip)),k=d(b.load(++c.ip)),c.gpr[j]=e(c.gpr[j]+c.gpr[k]),c.ip++;break;case a.ADD_REGADDRESS_TO_REG:j=d(b.load(++c.ip)),k=d(b.load(++c.ip)),c.gpr[j]=e(c.gpr[j]+b.load(c.gpr[k])),c.ip++;break;case a.ADD_ADDRESS_TO_REG:j=d(b.load(++c.ip)),l=b.load(++c.ip),c.gpr[j]=e(c.gpr[j]+b.load(l)),c.ip++;break;case a.ADD_NUMBER_TO_REG:j=d(b.load(++c.ip)),n=b.load(++c.ip),c.gpr[j]=e(c.gpr[j]+n),c.ip++;break;case a.SUB_REG_FROM_REG:j=d(b.load(++c.ip)),k=d(b.load(++c.ip)),c.gpr[j]=e(c.gpr[j]-c.gpr[k]),c.ip++;break;case a.SUB_REGADDRESS_FROM_REG:j=d(b.load(++c.ip)),k=d(b.load(++c.ip)),c.gpr[j]=e(c.gpr[j]-b.load(c.gpr[k])),c.ip++;break;case a.SUB_ADDRESS_FROM_REG:j=d(b.load(++c.ip)),l=b.load(++c.ip),c.gpr[j]=e(c.gpr[j]-b.load(l)),c.ip++;break;case a.SUB_NUMBER_FROM_REG:j=d(b.load(++c.ip)),n=b.load(++c.ip),c.gpr[j]=e(c.gpr[j]-n),c.ip++;break;case a.INC_REG:j=d(b.load(++c.ip)),c.gpr[j]=e(c.gpr[j]+1),c.ip++;break;case a.DEC_REG:j=d(b.load(++c.ip)),c.gpr[j]=e(c.gpr[j]-1),c.ip++;break;case a.CMP_REG_WITH_REG:j=d(b.load(++c.ip)),k=d(b.load(++c.ip)),e(c.gpr[j]-c.gpr[k]),c.ip++;break;case a.CMP_REGADDRESS_WITH_REG:j=d(b.load(++c.ip)),k=d(b.load(++c.ip)),e(c.gpr[j]-b.load(c.gpr[k])),c.ip++;break;case a.CMP_ADDRESS_WITH_REG:j=d(b.load(++c.ip)),l=b.load(++c.ip),e(c.gpr[j]-b.load(l)),c.ip++;break;case a.CMP_NUMBER_WITH_REG:j=d(b.load(++c.ip)),n=b.load(++c.ip),e(c.gpr[j]-n),c.ip++;break;case a.JMP_REGADDRESS:j=d(b.load(++c.ip)),f(c.gpr[j]);break;case a.JMP_ADDRESS:n=b.load(++c.ip),f(n);break;case a.JC_REGADDRESS:j=d(b.load(++c.ip)),c.carry?f(c.gpr[j]):c.ip++;break;case a.JC_ADDRESS:n=b.load(++c.ip),c.carry?f(n):c.ip++;break;case a.JNC_REGADDRESS:j=d(b.load(++c.ip)),c.carry?c.ip++:f(c.gpr[j]);break;case a.JNC_ADDRESS:n=b.load(++c.ip),c.carry?c.ip++:f(n);break;case a.JZ_REGADDRESS:j=d(b.load(++c.ip)),c.zero?f(c.gpr[j]):c.ip++;break;case a.JZ_ADDRESS:n=b.load(++c.ip),c.zero?f(n):c.ip++;break;case a.JNZ_REGADDRESS:j=d(b.load(++c.ip)),c.zero?c.ip++:f(c.gpr[j]);break;case a.JNZ_ADDRESS:n=b.load(++c.ip),c.zero?c.ip++:f(n);break;case a.JA_REGADDRESS:j=d(b.load(++c.ip)),c.zero||c.carry?c.ip++:f(c.gpr[j]);break;case a.JA_ADDRESS:n=b.load(++c.ip),c.zero||c.carry?c.ip++:f(n);break;case a.JNA_REGADDRESS:j=d(b.load(++c.ip)),c.zero||c.carry?f(c.gpr[j]):c.ip++;break;case a.JNA_ADDRESS:n=b.load(++c.ip),c.zero||c.carry?f(n):c.ip++;break;case a.PUSH_REG:k=d(b.load(++c.ip)),g(c.gpr[k]),c.ip++;break;case a.PUSH_REGADDRESS:k=d(b.load(++c.ip)),g(b.load(c.gpr[k])),c.ip++;break;case a.PUSH_ADDRESS:l=b.load(++c.ip),g(b.load(l)),c.ip++;break;case a.PUSH_NUMBER:n=b.load(++c.ip),g(n),c.ip++;break;case a.POP_REG:j=d(b.load(++c.ip)),c.gpr[j]=h(),c.ip++;break;case a.CALL_REGADDRESS:j=d(b.load(++c.ip)),g(c.ip+1),f(c.gpr[j]);break;case a.CALL_ADDRESS:n=b.load(++c.ip),g(c.ip+1),f(n);break;case a.RET:f(h());break;case a.MUL_REG:k=d(b.load(++c.ip)),c.gpr[0]=e(c.gpr[0]*c.gpr[k]),c.ip++;break;case a.MUL_REGADDRESS:k=d(b.load(++c.ip)),c.gpr[0]=e(c.gpr[0]*b.load(c.gpr[k])),c.ip++;break;case a.MUL_ADDRESS:l=b.load(++c.ip),c.gpr[0]=e(c.gpr[0]*b.load(l)),c.ip++;break;case a.MUL_NUMBER:n=b.load(++c.ip),c.gpr[0]=e(c.gpr[0]*n),c.ip++;break;case a.DIV_REG:k=d(b.load(++c.ip)),c.gpr[0]=e(i(c.gpr[k])),c.ip++;break;case a.DIV_REGADDRESS:k=d(b.load(++c.ip)),c.gpr[0]=e(i(b.load(c.gpr[k]))),c.ip++;break;case a.DIV_ADDRESS:l=b.load(++c.ip),c.gpr[0]=e(i(b.load(l))),c.ip++;break;case a.DIV_NUMBER:n=b.load(++c.ip),c.gpr[0]=e(i(n)),c.ip++;break;case a.AND_REG_WITH_REG:j=d(b.load(++c.ip)),k=d(b.load(++c.ip)),c.gpr[j]=e(c.gpr[j]&c.gpr[k]),c.ip++;break;case a.AND_REGADDRESS_WITH_REG:j=d(b.load(++c.ip)),k=d(b.load(++c.ip)),c.gpr[j]=e(c.gpr[j]&b.load(c.gpr[k])),c.ip++;break;case a.AND_ADDRESS_WITH_REG:j=d(b.load(++c.ip)),l=b.load(++c.ip),c.gpr[j]=e(c.gpr[j]&b.load(l)),c.ip++;break;case a.AND_NUMBER_WITH_REG:j=d(b.load(++c.ip)),n=b.load(++c.ip),c.gpr[j]=e(c.gpr[j]&n),c.ip++;break;case a.OR_REG_WITH_REG:j=d(b.load(++c.ip)),k=d(b.load(++c.ip)),c.gpr[j]=e(c.gpr[j]|c.gpr[k]),c.ip++;break;case a.OR_REGADDRESS_WITH_REG:j=d(b.load(++c.ip)),k=d(b.load(++c.ip)),c.gpr[j]=e(c.gpr[j]|b.load(c.gpr[k])),c.ip++;break;case a.OR_ADDRESS_WITH_REG:j=d(b.load(++c.ip)),l=b.load(++c.ip),c.gpr[j]=e(c.gpr[j]|b.load(l)),c.ip++;break;case a.OR_NUMBER_WITH_REG:j=d(b.load(++c.ip)),n=b.load(++c.ip),c.gpr[j]=e(c.gpr[j]|n),c.ip++;break;case a.XOR_REG_WITH_REG:j=d(b.load(++c.ip)),k=d(b.load(++c.ip)),c.gpr[j]=e(c.gpr[j]^c.gpr[k]),c.ip++;break;case a.XOR_REGADDRESS_WITH_REG:j=d(b.load(++c.ip)),k=d(b.load(++c.ip)),c.gpr[j]=e(c.gpr[j]^b.load(c.gpr[k])),c.ip++;break;case a.XOR_ADDRESS_WITH_REG:j=d(b.load(++c.ip)),l=b.load(++c.ip),c.gpr[j]=e(c.gpr[j]^b.load(l)),c.ip++;break;case a.XOR_NUMBER_WITH_REG:j=d(b.load(++c.ip)),n=b.load(++c.ip),c.gpr[j]=e(c.gpr[j]^n),c.ip++;break;case a.NOT_REG:j=d(b.load(++c.ip)),c.gpr[j]=e(~c.gpr[j]),c.ip++;break;case a.SHL_REG_WITH_REG:j=d(b.load(++c.ip)),k=d(b.load(++c.ip)),c.gpr[j]=e(c.gpr[j]<<c.gpr[k]),c.ip++;break;case a.SHL_REGADDRESS_WITH_REG:j=d(b.load(++c.ip)),k=d(b.load(++c.ip)),c.gpr[j]=e(c.gpr[j]<<b.load(c.gpr[k])),c.ip++;break;case a.SHL_ADDRESS_WITH_REG:j=d(b.load(++c.ip)),l=b.load(++c.ip),c.gpr[j]=e(c.gpr[j]<<b.load(l)),c.ip++;break;case a.SHL_NUMBER_WITH_REG:j=d(b.load(++c.ip)),n=b.load(++c.ip),c.gpr[j]=e(c.gpr[j]<<n),c.ip++;break;case a.SHR_REG_WITH_REG:j=d(b.load(++c.ip)),k=d(b.load(++c.ip)),c.gpr[j]=e(c.gpr[j]>>>c.gpr[k]),c.ip++;break;case a.SHR_REGADDRESS_WITH_REG:j=d(b.load(++c.ip)),k=d(b.load(++c.ip)),c.gpr[j]=e(c.gpr[j]>>>b.load(c.gpr[k])),c.ip++;break;case a.SHR_ADDRESS_WITH_REG:j=d(b.load(++c.ip)),l=b.load(++c.ip),c.gpr[j]=e(c.gpr[j]>>>b.load(l)),c.ip++;break;case a.SHR_NUMBER_WITH_REG:j=d(b.load(++c.ip)),n=b.load(++c.ip),c.gpr[j]=e(c.gpr[j]>>>n),c.ip++;break;default:throw"Invalid op code: "+o}return!0}catch(p){throw c.fault=!0,p}},reset:function(){var a=this;a.gpr=[0,0,0,0],a.sp=231,a.ip=0,a.zero=!1,a.carry=!1,a.fault=!1}};return c.reset(),c}]),app.service("memory",[function(){var a={data:Array(256),lastAccess:-1,load:function(a){var b=this;if(0>a||a>=b.data.length)throw"Memory access violation at "+a;return b.lastAccess=a,b.data[a]},store:function(a,b){var c=this;if(0>a||a>=c.data.length)throw"Memory access violation at "+a;c.lastAccess=a,c.data[a]=b},reset:function(){var a=this;a.lastAccess=-1;for(var b=0,c=a.data.length;c>b;b++)a.data[b]=0}};return a.reset(),a}]),app.service("opcodes",[function(){var a={NONE:0,MOV_REG_TO_REG:1,MOV_ADDRESS_TO_REG:2,MOV_REGADDRESS_TO_REG:3,MOV_REG_TO_ADDRESS:4,MOV_REG_TO_REGADDRESS:5,MOV_NUMBER_TO_REG:6,MOV_NUMBER_TO_ADDRESS:7,MOV_NUMBER_TO_REGADDRESS:8,ADD_REG_TO_REG:10,ADD_REGADDRESS_TO_REG:11,ADD_ADDRESS_TO_REG:12,ADD_NUMBER_TO_REG:13,SUB_REG_FROM_REG:14,SUB_REGADDRESS_FROM_REG:15,SUB_ADDRESS_FROM_REG:16,SUB_NUMBER_FROM_REG:17,INC_REG:18,DEC_REG:19,CMP_REG_WITH_REG:20,CMP_REGADDRESS_WITH_REG:21,CMP_ADDRESS_WITH_REG:22,CMP_NUMBER_WITH_REG:23,JMP_REGADDRESS:30,JMP_ADDRESS:31,JC_REGADDRESS:32,JC_ADDRESS:33,JNC_REGADDRESS:34,JNC_ADDRESS:35,JZ_REGADDRESS:36,JZ_ADDRESS:37,JNZ_REGADDRESS:38,JNZ_ADDRESS:39,JA_REGADDRESS:40,JA_ADDRESS:41,JNA_REGADDRESS:42,JNA_ADDRESS:43,PUSH_REG:50,PUSH_REGADDRESS:51,PUSH_ADDRESS:52,PUSH_NUMBER:53,POP_REG:54,CALL_REGADDRESS:55,CALL_ADDRESS:56,RET:57,MUL_REG:60,MUL_REGADDRESS:61,MUL_ADDRESS:62,MUL_NUMBER:63,DIV_REG:64,DIV_REGADDRESS:65,DIV_ADDRESS:66,DIV_NUMBER:67,AND_REG_WITH_REG:70,AND_REGADDRESS_WITH_REG:71,AND_ADDRESS_WITH_REG:72,AND_NUMBER_WITH_REG:73,OR_REG_WITH_REG:74,OR_REGADDRESS_WITH_REG:75,OR_ADDRESS_WITH_REG:76,OR_NUMBER_WITH_REG:77,XOR_REG_WITH_REG:78,XOR_REGADDRESS_WITH_REG:79,XOR_ADDRESS_WITH_REG:80,XOR_NUMBER_WITH_REG:81,NOT_REG:82,SHL_REG_WITH_REG:90,SHL_REGADDRESS_WITH_REG:91,SHL_ADDRESS_WITH_REG:92,SHL_NUMBER_WITH_REG:93,SHR_REG_WITH_REG:94,SHR_REGADDRESS_WITH_REG:95,SHR_ADDRESS_WITH_REG:96,SHR_NUMBER_WITH_REG:97};return a}]),app.controller("Ctrl",["$scope","$timeout","cpu","memory","assembler",function(a,b,c,d,e){a.memory=d,a.cpu=c,a.error="",a.isRunning=!1,a.displayHex=!0,a.speeds=[{speed:1,desc:"1 HZ"},{speed:4,desc:"4 HZ"},{speed:8,desc:"8 HZ"},{speed:16,desc:"16 HZ"}],a.speed=4,a.code='; Simple example\n; Writes Hello World to the output\n\n	JMP start\nhello: DB "Hello World!" ; Variable\n       DB 0	; String terminator\n\nstart:\n	MOV C, hello    ; Point to var \n	MOV D, 232	; Point to output\n	CALL print\n	DB 0		; Stop execution\n\nprint:			; print(C:*from, D:*to)\n	PUSH A\n	PUSH B\n	MOV B, 0\n.loop:\n	MOV A, [C]	; Get char from var\n	MOV [D], A	; Write to output\n	INC C\n	INC D  \n	CMP B, [C]	; Check if end\n	JNZ .loop	; jump if not\n\n	POP B\n	POP A\n	RET',a.reset=function(){c.reset(),d.reset(),a.error="",a.selectedLine=-1},a.executeStep=function(){a.checkPrgrmLoaded()||a.assemble();try{return c.step()}catch(b){return a.error=b,!1}};var f;a.run=function(){a.checkPrgrmLoaded()||a.assemble(),a.isRunning=!0,f=b(function(){a.executeStep()===!0?a.run():a.isRunning=!1},1e3/a.speed)},a.stop=function(){b.cancel(f),a.isRunning=!1},a.checkPrgrmLoaded=function(){for(var a=0,b=d.data.length;b>a;a++)if(0!==d.data[a])return!0;return!1},a.getChar=function(a){var b=String.fromCharCode(a);return""===b.trim()?"  ":b},a.assemble=function(){try{a.reset();var b=e.go(a.code);if(b.length>d.data.length)throw"Binary code does not fit into the memory. Max "+d.data.length+" bytes are allowed";for(var c=0,f=b.length;f>c;c++)d.data[c]=b[c]}catch(g){void 0!==g.line?(a.error=g.line+" | "+g.error,a.selectedLine=g.line):a.error=g.error}}}]),app.filter("flag",function(){return function(a){return a.toString().toUpperCase()}}),app.filter("number",function(){return function(a,b){if(b){var c=a.toString(16).toUpperCase();return 1==c.length?"0"+c:c}return a.toString(10)}}),app.directive("selectLine",[function(){return{restrict:"A",link:function(a,b){a.$watch("selectedLine",function(){if(a.selectedLine>=0){for(var c=b[0].value.split("\n"),d=0,e=0;e<c.length&&e!=a.selectedLine;e++)d+=c[e].length+1;var f=c[a.selectedLine].length+d;if("undefined"!=typeof b[0].selectionStart&&(b[0].focus(),b[0].selectionStart=d,b[0].selectionEnd=f),document.selection&&document.selection.createRange){b[0].focus(),b[0].select();var g=document.selection.createRange();g.collapse(!0),g.moveEnd("character",f),g.moveStart("character",d),g.select()}}})}}}]),app.filter("startFrom",function(){return function(a,b){return b=+b,a.slice(b)}}),app.directive("tabSupport",[function(){return{restrict:"A",link:function(a,b){b.bind("keydown",function(a){if(9===a.keyCode){var b=this.value,c=this.selectionStart,d=this.selectionEnd;return this.value=b.substring(0,c)+"	"+b.substring(d),this.selectionStart=this.selectionEnd=c+1,a.preventDefault(),!1}})}}}]);