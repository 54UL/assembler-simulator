/*! asmsimulator 08-10-2014 */
var app=angular.module("ASMSimulator",[]);app.service("assembler",["opcodes",function(a){return{go:function(b){for(var c=/^[\t ]*(?:([.A-Za-z]\w*)[:])?(?:[\t ]*([A-Za-z]{2,4})(?:[\t ]+(\[(\w+|SP(\+|-)\d+)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*)(?:[\t ]*[,][\t ]*(\[(\w+|SP(\+|-)\d+)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*))?)?)?/,d=3,e=6,f=/^[-+]?[0-9]+$/,g=/^[.A-Za-z]\w*$/,h=[],i={},j={},k=b.split("\n"),l=function(a){if("0x"===a.slice(0,2))return parseInt(a.slice(2),16);if("0o"===a.slice(0,2))return parseInt(a.slice(2),8);if("b"===a.slice(a.length-1))return parseInt(a.slice(0,a.length-1),2);if("d"===a.slice(a.length-1))return parseInt(a.slice(0,a.length-1),10);if(f.exec(a))return parseInt(a,10);throw"Invalid number format"},m=function(a){return a=a.toUpperCase(),"A"===a?0:"B"===a?1:"C"===a?2:"D"===a?3:void 0},n=function(a){a=a.toUpperCase();var b=0;if("SP+"===a.slice(0,3))b=1;else{if("SP-"!==a.slice(0,3))return void 0;b=-1}var c=b*parseInt(a.slice(3),10);if(-16>c||c>15)throw"offset must be a value between -16...+15";return 0>c&&(c=32+c),8*c+4},o=function(a,b,c){var d=m(a);if(void 0!==d)return{type:b,value:d};var e=p(a);if(void 0!==e)return{type:c,value:e};if("regaddress"===b&&(d=n(a),void 0!==d))return{type:b,value:d};var f=l(a);if(isNaN(f))throw"Not a "+c+": "+f;if(0>f||f>255)throw c+" must have a value between 0-255";return{type:c,value:f}},p=function(a){return g.exec(a)?a.toUpperCase():void 0},q=function(a){switch(a.slice(0,1)){case"[":var b=a.slice(1,a.length-1);return o(b,"regaddress","address");case'"':for(var c=a.slice(1,a.length-1),d=[],e=0,f=c.length;f>e;e++)d.push(c.charCodeAt(e));return{type:"numbers",value:d};case"'":var g=a.slice(1,a.length-1);if(g.length>1)throw"Only one character is allowed. Use String instead";return{type:"number",value:g.charCodeAt(0)};default:return o(a,"register","number")}},r=(function(a){if(a=a.toUpperCase(),a in j)throw"Duplicate label: "+a;if("A"===a||"B"===a||"C"===a||"D"===a)throw"Label contains keyword: "+a;j[a]=h.length}),s=function(a,b){if(void 0!==b)throw a+": too many arguments"},t=0,u=k.length;u>t;t++)try{var v=c.exec(k[t]);if(void 0!==v[1]||void 0!==v[2]){if(void 0!==v[1]&&r(v[1]),void 0!==v[2]){var w,x,y,z=v[2].toUpperCase();switch("DB"!==z&&(i[h.length]=t),z){case"DB":if(w=q(v[d]),"number"===w.type)h.push(w.value);else{if("numbers"!==w.type)throw"DB does not support this operand";for(var A=0,B=w.value.length;B>A;A++)h.push(w.value[A])}break;case"HLT":s("HLT",v[d]),y=a.NONE,h.push(y);break;case"MOV":if(w=q(v[d]),x=q(v[e]),"register"===w.type&&"register"===x.type)y=a.MOV_REG_TO_REG;else if("register"===w.type&&"address"===x.type)y=a.MOV_ADDRESS_TO_REG;else if("register"===w.type&&"regaddress"===x.type)y=a.MOV_REGADDRESS_TO_REG;else if("address"===w.type&&"register"===x.type)y=a.MOV_REG_TO_ADDRESS;else if("regaddress"===w.type&&"register"===x.type)y=a.MOV_REG_TO_REGADDRESS;else if("register"===w.type&&"number"===x.type)y=a.MOV_NUMBER_TO_REG;else if("address"===w.type&&"number"===x.type)y=a.MOV_NUMBER_TO_ADDRESS;else{if("regaddress"!==w.type||"number"!==x.type)throw"MOV does not support this operands";y=a.MOV_NUMBER_TO_REGADDRESS}h.push(y,w.value,x.value);break;case"ADD":if(w=q(v[d]),x=q(v[e]),"register"===w.type&&"register"===x.type)y=a.ADD_REG_TO_REG;else if("register"===w.type&&"regaddress"===x.type)y=a.ADD_REGADDRESS_TO_REG;else if("register"===w.type&&"address"===x.type)y=a.ADD_ADDRESS_TO_REG;else{if("register"!==w.type||"number"!==x.type)throw"ADD does not support this operands";y=a.ADD_NUMBER_TO_REG}h.push(y,w.value,x.value);break;case"SUB":if(w=q(v[d]),x=q(v[e]),"register"===w.type&&"register"===x.type)y=a.SUB_REG_FROM_REG;else if("register"===w.type&&"regaddress"===x.type)y=a.SUB_REGADDRESS_FROM_REG;else if("register"===w.type&&"address"===x.type)y=a.SUB_ADDRESS_FROM_REG;else{if("register"!==w.type||"number"!==x.type)throw"SUB does not support this operands";y=a.SUB_NUMBER_FROM_REG}h.push(y,w.value,x.value);break;case"INC":if(w=q(v[d]),s("INC",v[e]),"register"!==w.type)throw"INC does not support this operand";y=a.INC_REG,h.push(y,w.value);break;case"DEC":if(w=q(v[d]),s("DEC",v[e]),"register"!==w.type)throw"DEC does not support this operand";y=a.DEC_REG,h.push(y,w.value);break;case"CMP":if(w=q(v[d]),x=q(v[e]),"register"===w.type&&"register"===x.type)y=a.CMP_REG_WITH_REG;else if("register"===w.type&&"regaddress"===x.type)y=a.CMP_REGADDRESS_WITH_REG;else if("register"===w.type&&"address"===x.type)y=a.CMP_ADDRESS_WITH_REG;else{if("register"!==w.type||"number"!==x.type)throw"CMP does not support this operands";y=a.CMP_NUMBER_WITH_REG}h.push(y,w.value,x.value);break;case"JMP":if(w=q(v[d]),s("JMP",v[e]),"register"===w.type)y=a.JMP_REGADDRESS;else{if("number"!==w.type)throw"JMP does not support this operands";y=a.JMP_ADDRESS}h.push(y,w.value);break;case"JC":case"JB":case"JNAE":if(w=q(v[d]),s(z,v[e]),"register"===w.type)y=a.JC_REGADDRESS;else{if("number"!==w.type)throw z+" does not support this operand";y=a.JC_ADDRESS}h.push(y,w.value);break;case"JNC":case"JNB":case"JAE":if(w=q(v[d]),s(z,v[e]),"register"===w.type)y=a.JNC_REGADDRESS;else{if("number"!==w.type)throw z+"does not support this operand";y=a.JNC_ADDRESS}h.push(y,w.value);break;case"JZ":case"JE":if(w=q(v[d]),s(z,v[e]),"register"===w.type)y=a.JZ_REGADDRESS;else{if("number"!==w.type)throw z+" does not support this operand";y=a.JZ_ADDRESS}h.push(y,w.value);break;case"JNZ":case"JNE":if(w=q(v[d]),s(z,v[e]),"register"===w.type)y=a.JNZ_REGADDRESS;else{if("number"!==w.type)throw z+" does not support this operand";y=a.JNZ_ADDRESS}h.push(y,w.value);break;case"JA":case"JNBE":if(w=q(v[d]),s(z,v[e]),"register"===w.type)y=a.JA_REGADDRESS;else{if("number"!==w.type)throw z+" does not support this operand";y=a.JA_ADDRESS}h.push(y,w.value);break;case"JNA":case"JBE":if(w=q(v[d]),s(z,v[e]),"register"===w.type)y=a.JNA_REGADDRESS;else{if("number"!==w.type)throw z+" does not support this operand";y=a.JNA_ADDRESS}h.push(y,w.value);break;case"PUSH":if(w=q(v[d]),s(z,v[e]),"register"===w.type)y=a.PUSH_REG;else if("regaddress"===w.type)y=a.PUSH_REGADDRESS;else if("address"===w.type)y=a.PUSH_ADDRESS;else{if("number"!==w.type)throw"PUSH does not support this operand";y=a.PUSH_NUMBER}h.push(y,w.value);break;case"POP":if(w=q(v[d]),s(z,v[e]),"register"!==w.type)throw"PUSH does not support this operand";y=a.POP_REG,h.push(y,w.value);break;case"CALL":if(w=q(v[d]),s(z,v[e]),"register"===w.type)y=a.CALL_REGADDRESS;else{if("number"!==w.type)throw"CALL does not support this operand";y=a.CALL_ADDRESS}h.push(y,w.value);break;case"RET":s(z,v[d]),y=a.RET,h.push(y);break;case"MUL":if(w=q(v[d]),s(z,v[e]),"register"===w.type)y=a.MUL_REG;else if("regaddress"===w.type)y=a.MUL_REGADDRESS;else if("address"===w.type)y=a.MUL_ADDRESS;else{if("number"!==w.type)throw"MULL does not support this operand";y=a.MUL_NUMBER}h.push(y,w.value);break;case"DIV":if(w=q(v[d]),s(z,v[e]),"register"===w.type)y=a.DIV_REG;else if("regaddress"===w.type)y=a.DIV_REGADDRESS;else if("address"===w.type)y=a.DIV_ADDRESS;else{if("number"!==w.type)throw"DIV does not support this operand";y=a.DIV_NUMBER}h.push(y,w.value);break;case"AND":if(w=q(v[d]),x=q(v[e]),"register"===w.type&&"register"===x.type)y=a.AND_REG_WITH_REG;else if("register"===w.type&&"regaddress"===x.type)y=a.AND_REGADDRESS_WITH_REG;else if("register"===w.type&&"address"===x.type)y=a.AND_ADDRESS_WITH_REG;else{if("register"!==w.type||"number"!==x.type)throw"AND does not support this operands";y=a.AND_NUMBER_WITH_REG}h.push(y,w.value,x.value);break;case"OR":if(w=q(v[d]),x=q(v[e]),"register"===w.type&&"register"===x.type)y=a.OR_REG_WITH_REG;else if("register"===w.type&&"regaddress"===x.type)y=a.OR_REGADDRESS_WITH_REG;else if("register"===w.type&&"address"===x.type)y=a.OR_ADDRESS_WITH_REG;else{if("register"!==w.type||"number"!==x.type)throw"OR does not support this operands";y=a.OR_NUMBER_WITH_REG}h.push(y,w.value,x.value);break;case"XOR":if(w=q(v[d]),x=q(v[e]),"register"===w.type&&"register"===x.type)y=a.XOR_REG_WITH_REG;else if("register"===w.type&&"regaddress"===x.type)y=a.XOR_REGADDRESS_WITH_REG;else if("register"===w.type&&"address"===x.type)y=a.XOR_ADDRESS_WITH_REG;else{if("register"!==w.type||"number"!==x.type)throw"XOR does not support this operands";y=a.XOR_NUMBER_WITH_REG}h.push(y,w.value,x.value);break;case"NOT":if(w=q(v[d]),s(z,v[e]),"register"!==w.type)throw"NOT does not support this operand";y=a.NOT_REG,h.push(y,w.value);break;case"SHL":case"SAL":if(w=q(v[d]),x=q(v[e]),"register"===w.type&&"register"===x.type)y=a.SHL_REG_WITH_REG;else if("register"===w.type&&"regaddress"===x.type)y=a.SHL_REGADDRESS_WITH_REG;else if("register"===w.type&&"address"===x.type)y=a.SHL_ADDRESS_WITH_REG;else{if("register"!==w.type||"number"!==x.type)throw z+" does not support this operands";y=a.SHL_NUMBER_WITH_REG}h.push(y,w.value,x.value);break;case"SHR":case"SAR":if(w=q(v[d]),x=q(v[e]),"register"===w.type&&"register"===x.type)y=a.SHR_REG_WITH_REG;else if("register"===w.type&&"regaddress"===x.type)y=a.SHR_REGADDRESS_WITH_REG;else if("register"===w.type&&"address"===x.type)y=a.SHR_ADDRESS_WITH_REG;else{if("register"!==w.type||"number"!==x.type)throw z+" does not support this operands";y=a.SHR_NUMBER_WITH_REG}h.push(y,w.value,x.value);break;default:throw"Invalid instruction: "+v[2]}}}else{var C=k[t].trim();if(""!==C&&";"!==C.slice(0,1))throw"Syntax error"}}catch(D){throw{error:D,line:t}}for(t=0,u=h.length;u>t;t++)if(!angular.isNumber(h[t])){if(!(h[t]in j))throw{error:"Undefined label: "+h[t]};h[t]=j[h[t]]}return{code:h,mapping:i}}}}]),app.service("cpu",["opcodes","memory",function(a,b){var c={step:function(){var c=this;if(c.fault===!0)throw"FAULT. Reset to continue.";try{var d=function(a){if(0>a||a>=c.gpr.length)throw"Invalid register: "+a;return a},e=function(a){var b,d=a%8;b=d<c.gpr.length?c.gpr[d]:c.sp;var e=Math.floor(a/8);return e>15&&(e-=32),b+e},f=function(a){return c.zero=!1,c.carry=!1,a>=256?(c.carry=!0,a%=256):0===a?c.zero=!0:0>a&&(c.carry=!0,a=255- -a%256),a},g=function(a){if(0>a||a>=b.data.length)throw"IP outside memory";c.ip=a},h=function(a){if(b.store(c.sp--,a),c.sp<0)throw"Stack overflow"},i=function(){var a=b.load(++c.sp);if(c.sp>231)throw"Stack underflow";return a},j=function(a){if(0===a)throw"Division by 0";return Math.floor(c.gpr[0]/a)};if(c.ip<0||c.ip>=b.data.length)throw"Instruction pointer is outside of memory";var k,l,m,n,o,p=b.load(c.ip);switch(p){case a.NONE:return!1;case a.MOV_REG_TO_REG:k=d(b.load(++c.ip)),l=d(b.load(++c.ip)),c.gpr[k]=c.gpr[l],c.ip++;break;case a.MOV_ADDRESS_TO_REG:k=d(b.load(++c.ip)),m=b.load(++c.ip),c.gpr[k]=b.load(m),c.ip++;break;case a.MOV_REGADDRESS_TO_REG:k=d(b.load(++c.ip)),l=b.load(++c.ip),c.gpr[k]=b.load(e(l)),c.ip++;break;case a.MOV_REG_TO_ADDRESS:n=b.load(++c.ip),l=d(b.load(++c.ip)),b.store(n,c.gpr[l]),c.ip++;break;case a.MOV_REG_TO_REGADDRESS:k=b.load(++c.ip),l=d(b.load(++c.ip)),b.store(e(k),c.gpr[l]),c.ip++;break;case a.MOV_NUMBER_TO_REG:k=d(b.load(++c.ip)),o=b.load(++c.ip),c.gpr[k]=o,c.ip++;break;case a.MOV_NUMBER_TO_ADDRESS:n=b.load(++c.ip),o=b.load(++c.ip),b.store(n,o),c.ip++;break;case a.MOV_NUMBER_TO_REGADDRESS:k=b.load(++c.ip),o=b.load(++c.ip),b.store(e(k),o),c.ip++;break;case a.ADD_REG_TO_REG:k=d(b.load(++c.ip)),l=d(b.load(++c.ip)),c.gpr[k]=f(c.gpr[k]+c.gpr[l]),c.ip++;break;case a.ADD_REGADDRESS_TO_REG:k=d(b.load(++c.ip)),l=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]+b.load(e(l))),c.ip++;break;case a.ADD_ADDRESS_TO_REG:k=d(b.load(++c.ip)),m=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]+b.load(m)),c.ip++;break;case a.ADD_NUMBER_TO_REG:k=d(b.load(++c.ip)),o=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]+o),c.ip++;break;case a.SUB_REG_FROM_REG:k=d(b.load(++c.ip)),l=d(b.load(++c.ip)),c.gpr[k]=f(c.gpr[k]-c.gpr[l]),c.ip++;break;case a.SUB_REGADDRESS_FROM_REG:k=d(b.load(++c.ip)),l=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]-b.load(e(l))),c.ip++;break;case a.SUB_ADDRESS_FROM_REG:k=d(b.load(++c.ip)),m=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]-b.load(m)),c.ip++;break;case a.SUB_NUMBER_FROM_REG:k=d(b.load(++c.ip)),o=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]-o),c.ip++;break;case a.INC_REG:k=d(b.load(++c.ip)),c.gpr[k]=f(c.gpr[k]+1),c.ip++;break;case a.DEC_REG:k=d(b.load(++c.ip)),c.gpr[k]=f(c.gpr[k]-1),c.ip++;break;case a.CMP_REG_WITH_REG:k=d(b.load(++c.ip)),l=d(b.load(++c.ip)),f(c.gpr[k]-c.gpr[l]),c.ip++;break;case a.CMP_REGADDRESS_WITH_REG:k=d(b.load(++c.ip)),l=b.load(++c.ip),f(c.gpr[k]-b.load(e(l))),c.ip++;break;case a.CMP_ADDRESS_WITH_REG:k=d(b.load(++c.ip)),m=b.load(++c.ip),f(c.gpr[k]-b.load(m)),c.ip++;break;case a.CMP_NUMBER_WITH_REG:k=d(b.load(++c.ip)),o=b.load(++c.ip),f(c.gpr[k]-o),c.ip++;break;case a.JMP_REGADDRESS:k=d(b.load(++c.ip)),g(c.gpr[k]);break;case a.JMP_ADDRESS:o=b.load(++c.ip),g(o);break;case a.JC_REGADDRESS:k=d(b.load(++c.ip)),c.carry?g(c.gpr[k]):c.ip++;break;case a.JC_ADDRESS:o=b.load(++c.ip),c.carry?g(o):c.ip++;break;case a.JNC_REGADDRESS:k=d(b.load(++c.ip)),c.carry?c.ip++:g(c.gpr[k]);break;case a.JNC_ADDRESS:o=b.load(++c.ip),c.carry?c.ip++:g(o);break;case a.JZ_REGADDRESS:k=d(b.load(++c.ip)),c.zero?g(c.gpr[k]):c.ip++;break;case a.JZ_ADDRESS:o=b.load(++c.ip),c.zero?g(o):c.ip++;break;case a.JNZ_REGADDRESS:k=d(b.load(++c.ip)),c.zero?c.ip++:g(c.gpr[k]);break;case a.JNZ_ADDRESS:o=b.load(++c.ip),c.zero?c.ip++:g(o);break;case a.JA_REGADDRESS:k=d(b.load(++c.ip)),c.zero||c.carry?c.ip++:g(c.gpr[k]);break;case a.JA_ADDRESS:o=b.load(++c.ip),c.zero||c.carry?c.ip++:g(o);break;case a.JNA_REGADDRESS:k=d(b.load(++c.ip)),c.zero||c.carry?g(c.gpr[k]):c.ip++;break;case a.JNA_ADDRESS:o=b.load(++c.ip),c.zero||c.carry?g(o):c.ip++;break;case a.PUSH_REG:l=d(b.load(++c.ip)),h(c.gpr[l]),c.ip++;break;case a.PUSH_REGADDRESS:l=b.load(++c.ip),h(b.load(e(l))),c.ip++;break;case a.PUSH_ADDRESS:m=b.load(++c.ip),h(b.load(m)),c.ip++;break;case a.PUSH_NUMBER:o=b.load(++c.ip),h(o),c.ip++;break;case a.POP_REG:k=d(b.load(++c.ip)),c.gpr[k]=i(),c.ip++;break;case a.CALL_REGADDRESS:k=d(b.load(++c.ip)),h(c.ip+1),g(c.gpr[k]);break;case a.CALL_ADDRESS:o=b.load(++c.ip),h(c.ip+1),g(o);break;case a.RET:g(i());break;case a.MUL_REG:l=d(b.load(++c.ip)),c.gpr[0]=f(c.gpr[0]*c.gpr[l]),c.ip++;break;case a.MUL_REGADDRESS:l=b.load(++c.ip),c.gpr[0]=f(c.gpr[0]*b.load(e(l))),c.ip++;break;case a.MUL_ADDRESS:m=b.load(++c.ip),c.gpr[0]=f(c.gpr[0]*b.load(m)),c.ip++;break;case a.MUL_NUMBER:o=b.load(++c.ip),c.gpr[0]=f(c.gpr[0]*o),c.ip++;break;case a.DIV_REG:l=d(b.load(++c.ip)),c.gpr[0]=f(j(c.gpr[l])),c.ip++;break;case a.DIV_REGADDRESS:l=b.load(++c.ip),c.gpr[0]=f(j(b.load(e(l)))),c.ip++;break;case a.DIV_ADDRESS:m=b.load(++c.ip),c.gpr[0]=f(j(b.load(m))),c.ip++;break;case a.DIV_NUMBER:o=b.load(++c.ip),c.gpr[0]=f(j(o)),c.ip++;break;case a.AND_REG_WITH_REG:k=d(b.load(++c.ip)),l=d(b.load(++c.ip)),c.gpr[k]=f(c.gpr[k]&c.gpr[l]),c.ip++;break;case a.AND_REGADDRESS_WITH_REG:k=d(b.load(++c.ip)),l=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]&b.load(e(l))),c.ip++;break;case a.AND_ADDRESS_WITH_REG:k=d(b.load(++c.ip)),m=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]&b.load(m)),c.ip++;break;case a.AND_NUMBER_WITH_REG:k=d(b.load(++c.ip)),o=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]&o),c.ip++;break;case a.OR_REG_WITH_REG:k=d(b.load(++c.ip)),l=d(b.load(++c.ip)),c.gpr[k]=f(c.gpr[k]|c.gpr[l]),c.ip++;break;case a.OR_REGADDRESS_WITH_REG:k=d(b.load(++c.ip)),l=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]|b.load(e(l))),c.ip++;break;case a.OR_ADDRESS_WITH_REG:k=d(b.load(++c.ip)),m=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]|b.load(m)),c.ip++;break;case a.OR_NUMBER_WITH_REG:k=d(b.load(++c.ip)),o=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]|o),c.ip++;break;case a.XOR_REG_WITH_REG:k=d(b.load(++c.ip)),l=d(b.load(++c.ip)),c.gpr[k]=f(c.gpr[k]^c.gpr[l]),c.ip++;break;case a.XOR_REGADDRESS_WITH_REG:k=d(b.load(++c.ip)),l=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]^b.load(e(l))),c.ip++;break;case a.XOR_ADDRESS_WITH_REG:k=d(b.load(++c.ip)),m=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]^b.load(m)),c.ip++;break;case a.XOR_NUMBER_WITH_REG:k=d(b.load(++c.ip)),o=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]^o),c.ip++;break;case a.NOT_REG:k=d(b.load(++c.ip)),c.gpr[k]=f(~c.gpr[k]),c.ip++;break;case a.SHL_REG_WITH_REG:k=d(b.load(++c.ip)),l=d(b.load(++c.ip)),c.gpr[k]=f(c.gpr[k]<<c.gpr[l]),c.ip++;break;case a.SHL_REGADDRESS_WITH_REG:k=d(b.load(++c.ip)),l=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]<<b.load(e(l))),c.ip++;break;case a.SHL_ADDRESS_WITH_REG:k=d(b.load(++c.ip)),m=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]<<b.load(m)),c.ip++;break;case a.SHL_NUMBER_WITH_REG:k=d(b.load(++c.ip)),o=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]<<o),c.ip++;break;case a.SHR_REG_WITH_REG:k=d(b.load(++c.ip)),l=d(b.load(++c.ip)),c.gpr[k]=f(c.gpr[k]>>>c.gpr[l]),c.ip++;break;case a.SHR_REGADDRESS_WITH_REG:k=d(b.load(++c.ip)),l=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]>>>b.load(e(l))),c.ip++;break;case a.SHR_ADDRESS_WITH_REG:k=d(b.load(++c.ip)),m=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]>>>b.load(m)),c.ip++;break;case a.SHR_NUMBER_WITH_REG:k=d(b.load(++c.ip)),o=b.load(++c.ip),c.gpr[k]=f(c.gpr[k]>>>o),c.ip++;break;default:throw"Invalid op code: "+p}return!0}catch(q){throw c.fault=!0,q}},reset:function(){var a=this;a.gpr=[0,0,0,0],a.sp=231,a.ip=0,a.zero=!1,a.carry=!1,a.fault=!1}};return c.reset(),c}]),app.service("memory",[function(){var a={data:Array(256),lastAccess:-1,load:function(a){var b=this;if(0>a||a>=b.data.length)throw"Memory access violation at "+a;return b.lastAccess=a,b.data[a]},store:function(a,b){var c=this;if(0>a||a>=c.data.length)throw"Memory access violation at "+a;c.lastAccess=a,c.data[a]=b},reset:function(){var a=this;a.lastAccess=-1;for(var b=0,c=a.data.length;c>b;b++)a.data[b]=0}};return a.reset(),a}]),app.service("opcodes",[function(){var a={NONE:0,MOV_REG_TO_REG:1,MOV_ADDRESS_TO_REG:2,MOV_REGADDRESS_TO_REG:3,MOV_REG_TO_ADDRESS:4,MOV_REG_TO_REGADDRESS:5,MOV_NUMBER_TO_REG:6,MOV_NUMBER_TO_ADDRESS:7,MOV_NUMBER_TO_REGADDRESS:8,ADD_REG_TO_REG:10,ADD_REGADDRESS_TO_REG:11,ADD_ADDRESS_TO_REG:12,ADD_NUMBER_TO_REG:13,SUB_REG_FROM_REG:14,SUB_REGADDRESS_FROM_REG:15,SUB_ADDRESS_FROM_REG:16,SUB_NUMBER_FROM_REG:17,INC_REG:18,DEC_REG:19,CMP_REG_WITH_REG:20,CMP_REGADDRESS_WITH_REG:21,CMP_ADDRESS_WITH_REG:22,CMP_NUMBER_WITH_REG:23,JMP_REGADDRESS:30,JMP_ADDRESS:31,JC_REGADDRESS:32,JC_ADDRESS:33,JNC_REGADDRESS:34,JNC_ADDRESS:35,JZ_REGADDRESS:36,JZ_ADDRESS:37,JNZ_REGADDRESS:38,JNZ_ADDRESS:39,JA_REGADDRESS:40,JA_ADDRESS:41,JNA_REGADDRESS:42,JNA_ADDRESS:43,PUSH_REG:50,PUSH_REGADDRESS:51,PUSH_ADDRESS:52,PUSH_NUMBER:53,POP_REG:54,CALL_REGADDRESS:55,CALL_ADDRESS:56,RET:57,MUL_REG:60,MUL_REGADDRESS:61,MUL_ADDRESS:62,MUL_NUMBER:63,DIV_REG:64,DIV_REGADDRESS:65,DIV_ADDRESS:66,DIV_NUMBER:67,AND_REG_WITH_REG:70,AND_REGADDRESS_WITH_REG:71,AND_ADDRESS_WITH_REG:72,AND_NUMBER_WITH_REG:73,OR_REG_WITH_REG:74,OR_REGADDRESS_WITH_REG:75,OR_ADDRESS_WITH_REG:76,OR_NUMBER_WITH_REG:77,XOR_REG_WITH_REG:78,XOR_REGADDRESS_WITH_REG:79,XOR_ADDRESS_WITH_REG:80,XOR_NUMBER_WITH_REG:81,NOT_REG:82,SHL_REG_WITH_REG:90,SHL_REGADDRESS_WITH_REG:91,SHL_ADDRESS_WITH_REG:92,SHL_NUMBER_WITH_REG:93,SHR_REG_WITH_REG:94,SHR_REGADDRESS_WITH_REG:95,SHR_ADDRESS_WITH_REG:96,SHR_NUMBER_WITH_REG:97};return a}]),app.controller("Ctrl",["$scope","$timeout","cpu","memory","assembler",function(a,b,c,d,e){a.memory=d,a.cpu=c,a.error="",a.isRunning=!1,a.displayHex=!0,a.displayInstr=!0,a.speeds=[{speed:1,desc:"1 HZ"},{speed:4,desc:"4 HZ"},{speed:8,desc:"8 HZ"},{speed:16,desc:"16 HZ"}],a.speed=4,a.code='; Simple example\n; Writes Hello World to the output\n\n	JMP start\nhello: DB "Hello World!" ; Variable\n       DB 0	; String terminator\n\nstart:\n	MOV C, hello    ; Point to var \n	MOV D, 232	; Point to output\n	CALL print\n        HLT             ; Stop execution\n\nprint:			; print(C:*from, D:*to)\n	PUSH A\n	PUSH B\n	MOV B, 0\n.loop:\n	MOV A, [C]	; Get char from var\n	MOV [D], A	; Write to output\n	INC C\n	INC D  \n	CMP B, [C]	; Check if end\n	JNZ .loop	; jump if not\n\n	POP B\n	POP A\n	RET',a.reset=function(){c.reset(),d.reset(),a.error="",a.selectedLine=-1},a.executeStep=function(){a.checkPrgrmLoaded()||a.assemble();try{var b=c.step();return c.ip in a.mapping&&(a.selectedLine=a.mapping[c.ip]),b}catch(d){return a.error=d,!1}};var f;a.run=function(){a.checkPrgrmLoaded()||a.assemble(),a.isRunning=!0,f=b(function(){a.executeStep()===!0?a.run():a.isRunning=!1},1e3/a.speed)},a.stop=function(){b.cancel(f),a.isRunning=!1},a.checkPrgrmLoaded=function(){for(var a=0,b=d.data.length;b>a;a++)if(0!==d.data[a])return!0;return!1},a.getChar=function(a){var b=String.fromCharCode(a);return""===b.trim()?"  ":b},a.assemble=function(){try{a.reset();var b=e.go(a.code);a.mapping=b.mapping;var c=b.code;if(c.length>d.data.length)throw"Binary code does not fit into the memory. Max "+d.data.length+" bytes are allowed";for(var f=0,g=c.length;g>f;f++)d.data[f]=c[f]}catch(h){void 0!==h.line?(a.error=h.line+" | "+h.error,a.selectedLine=h.line):a.error=h.error}}}]),app.filter("flag",function(){return function(a){return a.toString().toUpperCase()}}),app.filter("number",function(){return function(a,b){if(b){var c=a.toString(16).toUpperCase();return 1==c.length?"0"+c:c}return a.toString(10)}}),app.directive("selectLine",[function(){return{restrict:"A",link:function(a,b){a.$watch("selectedLine",function(){if(a.selectedLine>=0){for(var c=b[0].value.split("\n"),d=0,e=0;e<c.length&&e!=a.selectedLine;e++)d+=c[e].length+1;var f=c[a.selectedLine].length+d;if("undefined"!=typeof b[0].selectionStart&&(b[0].focus(),b[0].selectionStart=d,b[0].selectionEnd=f),document.selection&&document.selection.createRange){b[0].focus(),b[0].select();var g=document.selection.createRange();g.collapse(!0),g.moveEnd("character",f),g.moveStart("character",d),g.select()}}})}}}]),app.filter("startFrom",function(){return function(a,b){return b=+b,a.slice(b)}}),app.directive("tabSupport",[function(){return{restrict:"A",link:function(a,b){b.bind("keydown",function(a){if(9===a.keyCode){var b=this.value,c=this.selectionStart,d=this.selectionEnd;return this.value=b.substring(0,c)+"	"+b.substring(d),this.selectionStart=this.selectionEnd=c+1,a.preventDefault(),!1}})}}}]);