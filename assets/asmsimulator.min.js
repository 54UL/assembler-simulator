/*! asmsimulator 26-10-2013 */
var app=angular.module("ASMSimulator",[]);app.service("assembler",[function(){return{go:function(a){for(var b=/^[\t ]*(?:([.A-Za-z]\w*)[:])?(?:[\t ]*([A-Za-z]{2,4})(?:[\t ]+(\[\w+\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*)(?:[\t ]*[,][\t ]*(\[\w+\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*))?))?/,c=/^[-+]?[0-9]+$/,d=/^[.A-Za-z]\w*$/,e=[],f={},g=a.split("\n"),h=function(a){if("0x"===a.slice(0,2))return parseInt(a.slice(2),16);if("0o"===a.slice(0,2))return parseInt(a.slice(2),8);if("b"===a.slice(a.length-1))return parseInt(a.slice(0,a.length-1),2);if("d"===a.slice(a.length-1))return parseInt(a.slice(0,a.length-1),10);if(c.exec(a))return parseInt(a,10);throw"Invalid number format"},i=function(a){return a=a.toUpperCase(),"A"===a?0:"B"===a?1:"C"===a?2:"D"===a?3:void 0},j=function(a,b,c){var d=i(a);if(void 0!==d)return{type:b,value:d};var e=k(a);if(void 0!==e)return{type:c,value:e};var f=h(a);if(isNaN(f))throw"Not a "+c+": "+f;if(0>f||f>255)throw c+" must have a value between 0-255";return{type:c,value:f}},k=function(a){return d.exec(a)?a.toUpperCase():void 0},l=function(a){switch(a.slice(0,1)){case"[":var b=a.slice(1,a.length-1);return j(b,"regaddress","address");case'"':for(var c=a.slice(1,a.length-1),d=[],e=0,f=c.length;f>e;e++)d.push(c.charCodeAt(e));return{type:"numbers",value:d};case"'":var g=a.slice(1,a.length-1);if(g.length>1)throw"Only one character is allowed. Use String instead";return{type:"number",value:g.charCodeAt(0)};default:return j(a,"register","number")}},m=(function(a){if(a=a.toUpperCase(),a in f)throw"Duplicate label: "+a;if("A"===a||"B"===a||"C"===a||"D"===a)throw"Label contains keyword: "+a;f[a]=e.length}),n=0,o=g.length;o>n;n++)try{var p=b.exec(g[n]);if(p){if(void 0!==p[1]&&m(p[1]),void 0!==p[2]){var q,r,s,t=p[2].toUpperCase();switch(t){case"DB":if(q=l(p[3]),"number"===q.type)e.push(q.value);else{if("numbers"!==q.type)throw"DB does not support this parameters";for(var u=0,v=q.value.length;v>u;u++)e.push(q.value[u])}break;case"MOV":if(q=l(p[3]),r=l(p[4]),"register"===q.type&&"register"===r.type)s=1;else if("register"===q.type&&"address"===r.type)s=2;else if("register"===q.type&&"regaddress"===r.type)s=3;else if("address"===q.type&&"register"===r.type)s=4;else if("regaddress"===q.type&&"register"===r.type)s=5;else if("register"===q.type&&"number"===r.type)s=6;else if("address"===q.type&&"number"===r.type)s=7;else{if("regaddress"!==q.type||"number"!==r.type)throw"MOV does not support this parameters";s=8}e.push(s,q.value,r.value);break;case"ADD":if(q=l(p[3]),r=l(p[4]),"register"===q.type&&"register"===r.type)s=10;else if("register"===q.type&&"regaddress"===r.type)s=11;else if("register"===q.type&&"address"===r.type)s=12;else{if("register"!==q.type||"number"!==r.type)throw"ADD does not support this parameters";s=13}e.push(s,q.value,r.value);break;case"SUB":if(q=l(p[3]),r=l(p[4]),"register"===q.type&&"register"===r.type)s=14;else if("register"===q.type&&"regaddress"===r.type)s=15;else if("register"===q.type&&"address"===r.type)s=16;else{if("register"!==q.type||"number"!==r.type)throw"SUB does not support this parameters";s=17}e.push(s,q.value,r.value);break;case"INC":if(q=l(p[3]),"register"!==q.type)throw"INC does not support this parameters";s=18,e.push(s,q.value);break;case"DEC":if(q=l(p[3]),"register"!==q.type)throw"DEC does not support this parameters";s=19,e.push(s,q.value);break;case"CMP":if(q=l(p[3]),r=l(p[4]),"register"===q.type&&"register"===r.type)s=20;else{if("register"!==q.type||"number"!==r.type)throw"CMP does not support this parameters";s=21}e.push(s,q.value,r.value);break;case"JMP":if(q=l(p[3]),"register"===q.type)s=30;else{if("number"!==q.type)throw"JMP does not support this parameters";s=31}e.push(s,q.value);break;case"JC":case"JB":case"JNAE":if(q=l(p[3]),"register"===q.type)s=32;else{if("number"!==q.type)throw"JC does not support this parameters";s=33}e.push(s,q.value);break;case"JNC":case"JNB":case"JAE":if(q=l(p[3]),"register"===q.type)s=34;else{if("number"!==q.type)throw"JNC does not support this parameters";s=35}e.push(s,q.value);break;case"JZ":case"JE":if(q=l(p[3]),"register"===q.type)s=36;else{if("number"!==q.type)throw t+" does not support this parameters";s=37}e.push(s,q.value);break;case"JNZ":case"JNE":if(q=l(p[3]),"register"===q.type)s=38;else{if("number"!==q.type)throw t+" does not support this parameters";s=39}e.push(s,q.value);break;case"JA":case"JNBE":if(q=l(p[3]),"register"===q.type)s=40;else{if("number"!==q.type)throw t+" does not support this parameters";s=41}e.push(s,q.value);break;case"JNA":case"JBE":if(q=l(p[3]),"register"===q.type)s=42;else{if("number"!==q.type)throw t+" does not support this parameters";s=43}e.push(s,q.value);break;default:throw"Invalid operand: "+p[2]}}}else if(";"!==g[n].trim().slice(0,1))throw"Syntax error"}catch(w){throw n+" | "+w}for(n=0,o=e.length;o>n;n++)if(!angular.isNumber(e[n])){if(!(e[n]in f))throw"Undefined label: "+e[n];e[n]=f[e[n]]}return e}}}]),app.service("cpu",["memory",function(a){var b={step:function(){var b=this;if(b.fault===!0)throw"FAULT. Reset to continue.";try{var c,d,e,f,g,h=a.load(b.ip),i=function(a){if(0>a||a>=b.gpr.length)throw"Invalid register: "+a;return a},j=function(a){return b.zero=!1,b.carry=!1,a>=256?(b.carry=!0,a%=256):0===a?b.zero=!0:0>a&&(b.carry=!0,a=255- -a%256),a},k=function(c){if(0>c||c>=a.data.length)throw"IP outside memory";b.ip=c};switch(h){case 0:return!1;case 1:c=i(a.load(++b.ip)),d=i(a.load(++b.ip)),b.gpr[c]=b.gpr[d],b.ip++;break;case 2:c=i(a.load(++b.ip)),e=a.load(++b.ip),b.gpr[c]=a.load(e),b.ip++;break;case 3:c=i(a.load(++b.ip)),d=i(a.load(++b.ip)),b.gpr[c]=a.load(b.gpr[d]),b.ip++;break;case 4:f=a.load(++b.ip),d=i(a.load(++b.ip)),a.store(f,b.gpr[d]),b.ip++;break;case 5:c=i(a.load(++b.ip)),d=i(a.load(++b.ip)),a.store(b.gpr[c],b.gpr[d]),b.ip++;break;case 6:c=i(a.load(++b.ip)),g=a.load(++b.ip),b.gpr[c]=g,b.ip++;break;case 7:f=a.load(++b.ip),g=a.load(++b.ip),a.store(f,g),b.ip++;break;case 8:c=i(a.load(++b.ip)),g=a.load(++b.ip),a.store(b.gpr[c],g),b.ip++;break;case 10:c=i(a.load(++b.ip)),d=i(a.load(++b.ip)),b.gpr[c]=j(b.gpr[c]+b.gpr[d]),b.ip++;break;case 11:c=i(a.load(++b.ip)),d=i(a.load(++b.ip)),b.gpr[c]=j(b.gpr[c]+a.load(b.gpr[d])),b.ip++;break;case 12:c=i(a.load(++b.ip)),e=a.load(++b.ip),b.gpr[c]=j(b.gpr[c]+a.load(e)),b.ip++;break;case 13:c=i(a.load(++b.ip)),g=a.load(++b.ip),b.gpr[c]=j(b.gpr[c]+g),b.ip++;break;case 14:c=i(a.load(++b.ip)),d=i(a.load(++b.ip)),b.gpr[c]=j(b.gpr[c]-b.gpr[d]),b.ip++;break;case 15:c=i(a.load(++b.ip)),d=i(a.load(++b.ip)),b.gpr[c]=j(b.gpr[c]-a.load(b.gpr[d])),b.ip++;break;case 16:c=i(a.load(++b.ip)),e=a.load(++b.ip),b.gpr[c]=j(b.gpr[c]-a.load(e)),b.ip++;break;case 17:c=i(a.load(++b.ip)),g=a.load(++b.ip),b.gpr[c]=j(b.gpr[c]-g),b.ip++;break;case 18:c=i(a.load(++b.ip)),b.gpr[c]=j(b.gpr[c]+1),b.ip++;break;case 19:c=i(a.load(++b.ip)),b.gpr[c]=j(b.gpr[c]-1),b.ip++;break;case 20:c=i(a.load(++b.ip)),d=i(a.load(++b.ip)),j(b.gpr[c]-b.gpr[d]),b.ip++;break;case 21:c=i(a.load(++b.ip)),g=a.load(++b.ip),j(b.gpr[c]-g),b.ip++;break;case 30:c=i(a.load(++b.ip)),k(b.gpr[c]);break;case 31:g=a.load(++b.ip),k(g);break;case 32:c=i(a.load(++b.ip)),b.carry&&k(b.gpr[c]);break;case 33:g=a.load(++b.ip),b.carry&&k(g);break;case 34:c=i(a.load(++b.ip)),b.carry||k(b.gpr[c]);break;case 35:g=a.load(++b.ip),b.carry||k(g);break;case 36:c=i(a.load(++b.ip)),b.zero&&k(b.gpr[c]);break;case 37:g=a.load(++b.ip),b.zero&&k(g);break;case 38:c=i(a.load(++b.ip)),b.zero||k(b.gpr[c]);break;case 39:g=a.load(++b.ip),b.zero||k(g);break;case 40:c=i(a.load(++b.ip)),b.zero||b.carry||k(b.gpr[c]);break;case 41:g=a.load(++b.ip),b.zero||b.carry||k(g);break;case 42:c=i(a.load(++b.ip)),(b.zero||b.carry)&&k(b.gpr[c]);break;case 43:g=a.load(++b.ip),(b.zero||b.carry)&&k(g);break;default:throw"Invalid op code: "+h}return!0}catch(l){throw b.fault=!0,l}},reset:function(){var a=this;a.gpr=[0,0,0,0],a.sp=232,a.ip=0,a.zero=!1,a.carry=!1,a.fault=!1}};return b.reset(),b}]),app.service("memory",[function(){var a={data:Array(256),lastAccess:-1,load:function(a){var b=this;if(0>a||a>=b.data.length)throw"Memory access violation at "+a;return b.lastAccess=a,b.data[a]},store:function(a,b){var c=this;if(0>a||a>=c.data.length)throw"Memory access violation at "+a;c.lastAccess=a,c.data[a]=b},reset:function(){var a=this;a.lastAccess=-1;for(var b=0,c=a.data.length;c>b;b++)a.data[b]=0}};return a.reset(),a}]),app.controller("Ctrl",["$scope","$timeout","cpu","memory","assembler",function(a,b,c,d,e){a.memory=d,a.cpu=c,a.error="",a.isRunning=!1,a.displayHex=!0,a.code='; Simple example\n; Writes Hello World to the output\n\n	JMP start\nhello: DB "Hello World!" ; Variable\n       DB 0\n\nstart:\n	MOV C, hello    ; Point to var \n	MOV D, 232	; Point to output\n.loop:\n	MOV A, [C]	; Get char from var\n	MOV [D], A	; Write to output\n	INC C\n	INC D\n	MOV A, [C]   \n	CMP A, 0	; Check if end\n	JNZ .loop	; jump if not',a.reset=function(){c.reset(),d.reset(),a.error=""},a.executeStep=function(){a.checkPrgrmLoaded()||a.assemble();try{return c.step()}catch(b){return a.error=b,!1}};var f;a.run=function(){a.checkPrgrmLoaded()||a.assemble(),a.isRunning=!0,f=b(function(){a.executeStep()===!0?a.run():a.isRunning=!1},300)},a.stop=function(){b.cancel(f),a.isRunning=!1},a.checkPrgrmLoaded=function(){for(var a=0,b=d.data.length;b>a;a++)if(0!==d.data[a])return!0;return!1},a.getChar=function(a){var b=String.fromCharCode(a);return""===b.trim()?"  ":b},a.assemble=function(){try{a.reset();var b=e.go(a.code);if(b.length>d.data.length)throw"Binary code does not fit into the memory. Max "+d.data.length+" bytes are allowed";for(var c=0,f=b.length;f>c;c++)d.data[c]=b[c]}catch(g){a.error=g}}}]),app.filter("startFrom",function(){return function(a,b){return b=+b,a.slice(b)}}),app.directive("tab-support",[function(){return{restrict:"A",link:function(a,b){b.bind("keydown",function(a){if(9===a.keyCode){var b=this.value,c=this.selectionStart,d=this.selectionEnd;return this.value=b.substring(0,c)+"	"+b.substring(d),this.selectionStart=this.selectionEnd=c+1,!1}})}}}]);